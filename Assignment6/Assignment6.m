%  Backward elimination

%[y x1 x2 x3 x4 x5 x6 x7 x8]
  A=[91.374796247587554 0.8198710314213975 0 0 23.51970325614181 0.2369616370544268 ...
   4 16 483.45538456836061;
   138.11567187901727 5.4301716978798984 0 0 21.7688346355698 0.23174375253775342 ...
   3.9 15.209999999999999 442.51546040535072;
   117.09117645101414 3.2211970259580891 1 0 21.903062659251667 0.28103239146721837 ...
   3.8 14.44 464.68387648321078;
   106.68826896299569 2.4438339968320055 1 0 21.113055880268842 0.21026232986738558 ...
   3.7 13.690000000000001 450.84425336073451;
   78.589962147493225 0.22326453475462027 0 1 16.282515958367167 0.22127629226746143 ...
   3.6 12.96 337.39996692414866;
   88.941894411369361 1.706270073209577 1 1 21.132923713574673 0.24464221878981487 ...
   3.5 12.25 445.55831550675691;
   159.85683309459534 9.5095270257045623 1 0 18.548725136321071 0.23865511714825205 ...
   3.4 11.559999999999999 373.97608524436646;
   95.43946017342185 3.383821900673134 0 0 16.808813982557837 0.27746478460871526 ...
   3.3 10.889999999999999 342.89214329941188;
   108.1746299115343 4.97872385070424 0 0 16.647857303061109 0.2474231132606704 ...
   3.2 10.240000000000002 336.03147103911112;
   84.440236859636187 3.7020119195604173 0 0 23.217162857311127 0.27967912193442113 ...
   3.1 9.6100000000000012 464.9858870330894;
   122.02127955793773 6.6122864990126722 1 1 18.021885536181134 0.20248594733248676 ...
   3 9 375.94555890399795;
   99.286879456916267 4.6568641611473582 1 0 19.95926206432992 0.29991400610693253 ...
   2.9 8.41 406.94582629940646;
   130.11985855030716 8.9272794509878466 0 0 19.104904203346784 0.22830534311451683 ...
   2.8 7.839999999999999 383.11517487575691;
   73.270232199830858 2.5955132268437175 0 1 18.109010625676223 0.27678249183946985 ...
   2.7 7.2900000000000009 384.67066895030763;
   111.31234745478214 6.8028991821055085 1 0 18.104929641959981 0.20350637132123328 ...
   2.6 6.7600000000000007 378.349960745204;
   92.60589445976197 5.3094924154942778 1 0 21.596219433651612 0.2870359462315582 ...
   2.5 6.25 458.38283553489816;
   42.582420178307466 0.4620619643432855 0 1 16.453851574931679 0.27429449593511779 ...
   2.4 5.76 345.91875353073328;
   101.96522245563241 6.7819544782878793 1 0 22.309732200812174 0.21092930448682812 ...
   2.3 5.2899999999999991 475.2553488870185;
   61.717407074423818 2.9832046419458882 1 1 18.338418949222223 0.28666167360444278 ...
   2.2 4.8400000000000007 389.34263355332337;
   35.27027449928 1.0534142397337398 1 0 22.715500973794555 0.28215255701244646 ...
   2.1 4.41 482.78850782203745;
   70.56778318605393 4.6751772110317127 1 0 19.877074278356851 0.20037917743656791 ...
   2 4 419.70590293522741;
   90.745460616315327 6.822945995887677 0 0 17.867828190700397 0.26602632833654594 ...
   1.9 3.61 365.26231423737107;
   94.379791518124264 7.7998215817789536 0 1 17.764282382307385 0.26323649306580987 ...
   1.8 3.24 357.91018477413286;
   102.58367269952748 8.27625377811253 1 0 18.51428103275223 0.2210481488409767 ...
   1.7 2.8899999999999997 390.86215916423339;
   56.754950548234355 4.28071766800133 1 1 23.963418917092582 0.24349466493336439 ...
   1.6 2.5600000000000005 503.58232443673558;
   60.05029240274218 5.0430844060646383 0 1 17.51305333269881 0.29331094011171011 ...
   1.5 2.25 354.78528523272655;
   68.1741747201435 6.3422185697747127 1 0 22.803927746891617 0.24572827278747372 ...
   1.4 1.9599999999999997 465.49296374186918;
   76.094190619266 7.2670312756816209 1 0 22.751238375456644 0.21100286033637933 ...
   1.3 1.6900000000000002 469.63562011760081;
   44.947543073931733 4.1296118495855394 0 1 20.226532074596442 0.26798913224075466 ...
   1.2 1.44 425.63957222162719;
   38.250001899125564 3.5631610782460763 1 0 21.318970650257356 0.297173224576134 ...
   1.1 1.2100000000000002 444.26196909400153];

y=A(:,1);   % Chemical Yield 
x1=A(:,2); % amount of catalyst
x2=A(:,3); % Preprocessing 2 (1/0)
x3=A(:,4); % Preprocessing 3 (1/0)
x4=A(:,5); % Humidity 
x5=A(:,6); % % Oxygen in env
x6=A(:,7); % time(s) for process
x7=A(:,8); % square of time of process
x8=A(:,9); % temperature(C)

tbl = table(y,x1,x2,x3,x4,x5,x6,x7,x8, 'VariableNames',{'y','x1','x2','x3', 'x4','x5','x6','x7','x8'})

% ------------------------------------------------------------------------------
% a)  Scatter plot y vs xi, i =[1:8], calculate their correlation.
corrPlot = figure;
[corr, Pvalue] = corrplot(tbl, 'testR','on');
correlation = corr([x1 x2 x3 x4 x5 x6 x7 x8],y)

%--------------------------------------------------------------------------------
% b) Perform regression analysis with all 8 variables. Calculate Rsquared and
% do residual analysis

tbl.x2 = categorical(tbl.x2); % convert categorical data columns
tbl.x3 = categorical(tbl.x3);

% Model 1: y = b0 + b1*cat +b2*pp2 + ... + b8*temp
mdl1 = fitlm(tbl, 'y~x1 + x2 + x3 + x4 + x5 + x6 + x7 + x8')

mdl1.Rsquared.Ordinary
mdl1.SSE
% Rsquared of 0.9978 and RMSE of 1.67(SSE= 58.6). Very nice. However, complex model. 

% Residual analysis....

% ------------------------------------------------------
% c) Propose model by backward selection. Calculate Rsquared. 

% 1. Choose significance level
alpha = 0.05;
% 2.  Analyze model with all variables(mdl1)

% 3. Choose variable with highest p-value such that if p>alpha, goto step 4.  else STOP



mdl2 = stepwiselm(tbl, 'y~ x1 +x2 +x3 +x4 + x5 +x6 +x7 +x8','verbose',2,'Penter',0) 
% 

% Final proposed model: 
% y = 0.2622 +10.1*x1 + 1.6634*x2 - 6.7139*x4 +11.7114*x6 + 3.6675*x7 + 0.2831*x8

%-------------------------------------------------------------------------
% d) Compare full model(mdl1) with proposed model(mdlStep)
% Is the model significantly better?
% Test H0: 
% H0: b3 = b5= 0 (the variables excluded from mdl2 make no difference)
% H1: atleast one of b3,b5 are /= 0

% Teststatistic:

% W = ((SSe2 -SSe1)/p)/(SSe1/(n-k-p-1)
% where
% p: #new variables = 2
% n - k -p -1 = dfe for model 1

% Reject h0 if W > c, W~ F(p,n-k-p-1) if H0 true
SSe1 = mdl1.SSE;
SSe2 = mdl2.SSE;
dfe1 = mdl1.DFE;
p = 2;

w = ((SSe2 -SSe1)/p)/(SSe1/dfe1)

c = finv(0.99,p,dfe1)

% w = 1.0159 < 5.78 = c ---> cannot reject H0

% Answer: No. Full model does not seem to describe the data better than mdl2. 
% Same model as in assignment 5, so makes sense that it would stop. 

